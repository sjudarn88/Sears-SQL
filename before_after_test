with t as    
    (select to_date(b.date) as day
            ,b.upcode
            ,c.partner
            ,b.device_type
            ,a.state_code
            ,cid
        from "PRODUCTION_DB"."PUBLIC"."PAY_MONTHLY_FUNNEL_STATES" a
        left join "PRODUCTION_DB"."PUBLIC"."PAY_MONTHLY_FUNNEL" b
        on a.state_code=b.state_code
        left join "PRODUCTION_DB"."PUBLIC"."UPLIFT_PARTNER_CODES" c
        on b.upcode=c.upcode
        where to_date(b.date)>='2019-04-01' and a.state_code in (11,14,15,70,94,95,96,97,101,102,103,104,105,106)
            and b.upcode in ('UP-73591399-1'
                            ,'UP-98841375-8'
                            ,'UP-49689944-1'
                            ,'UP-24792348-1'
                            ,'UP-60702809-1'
                            ,'UP-94385876-1'
                            ,'UP-98145157-50')
        group by 1,2,3,4,5,6
    )
    ,partial_funnel as(
      select day,upcode,partner,device_type
            ,count(case when state_code=11 then cid else null end) as approves
            ,count(case when state_code=14 then cid else null end) as confirm_loan_button
            ,count(case when state_code=15 then cid else null end) as confirmed_loan
            ,count(case when state_code=70 then cid else null end) as pm_booking
        from t
        group by 1,2,3,4   
    )
    ,visa1 as(
      select a.day,a.upcode,a.device_type,count(a.cid) as visa_blocking,count(b.cid) as visa2pm_booking
        from
        (select day,upcode,device_type,cid
            from t where state_code=105
            group by 1,2,3,4) a
        left join
        (select day,upcode,device_type,cid
            from t where state_code=70
            group by 1,2,3,4) b
        on a.day=b.day and a.upcode=b.upcode and a.device_type=b.device_type and a.cid=b.cid    
        group by 1,2,3
    )
    ,visa2 as(
      select a.day,a.upcode,a.device_type,count(b.cid) as visa2confirmed_loan
        from
        (select day,upcode,device_type,cid
            from t where state_code=105
            group by 1,2,3,4) a
        left join
        (select day,upcode,device_type,cid
            from t where state_code=15
            group by 1,2,3,4) b
        on a.day=b.day and a.upcode=b.upcode and a.device_type=b.device_type and a.cid=b.cid     
        group by 1,2,3
    )
    ,non_block as(
      select a.day,a.upcode,a.device_type,count(a.cid) as noblock,count(b.cid) as noblock2pm_booking
        from
        (select day,upcode,device_type,cid
            from t where state_code=15 and state_code not in (101,102,103,104,105,106)
            group by 1,2,3,4) a
        left join
        (select day,upcode,device_type,cid
            from t where state_code=70
            group by 1,2,3,4) b
        on a.day=b.day and a.upcode=b.upcode and a.device_type=b.device_type and a.cid=b.cid  
        group by 1,2,3
    )
    ,disable_autopay as(
      select day,upcode,device_type,count(cid) as dis_autopay
        from
        (select to_date(date) as day,upcode,device_type,cid
               ,max(case when state_code=96 then date else date_trunc('day', date) end) as c1
               ,max(case when state_code=97 then date else date_trunc('day', date) end) as c2
          from "PRODUCTION_DB"."PUBLIC"."PAY_MONTHLY_FUNNEL"
          where to_date(date)>='2019-04-01' and state_code in (96,97)
              and upcode in ('UP-73591399-1'
                              ,'UP-98841375-8'
                              ,'UP-49689944-1'
                              ,'UP-24792348-1'
                              ,'UP-60702809-1'
                              ,'UP-94385876-1'
                              ,'UP-98145157-50')
          group by 1,2,3,4
          having c2>c1) a
      group by 1,2,3
    )
        
    select p.*,ifnull(visa_blocking,0) as visa_blocking
            ,ifnull(v1.visa2pm_booking,0) as visa2pm_booking
            ,ifnull(v2.visa2confirmed_loan,0) as visa2confirmed_loan
            ,ifnull(n.noblock,0) as noblock
            ,ifnull(n.noblock2pm_booking,0) as noblock2pm_booking
            ,ifnull(dis_autopay,0) as dis_autopay
        from partial_funnel p
        left join visa1 v1
        on p.day=v1.day and p.upcode=v1.upcode and p.device_type=v1.device_type
        left join visa2 v2
        on p.day=v2.day and p.upcode=v2.upcode and p.device_type=v2.device_type
        left join non_block n
        on p.day=n.day and p.upcode=n.upcode and p.device_type=n.device_type
        left join disable_autopay d
        on p.day=d.day and p.upcode=d.upcode and p.device_type=d.device_type;
