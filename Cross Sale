###select loyaltycardIDs which purchased Kmart-Deptment=195 in quarter 20181,20182,20183
SELECT a1.LyltyCardNbr,a2.srsvrtclbsnss_kmtdvsn_nbr,a2.srskmtind
   FROM
    (SELECT LyltyCardNbr,KSNId,SrsKmtInd,SKUId
      FROM `syw-analytics-repo-prod.l2_enterpriseanalytics.postrandtl` 
      WHERE LyltyCardNbr IS NOT NULL 
            AND SrsKmtInd='K' 
            AND qtrnbr IN (20181, 20182, 20183)) a1
    INNER JOIN
    (SELECT SrsSKU_KmtKSN_Id
            , srskmtind 
        FROM `syw-analytics-repo-prod.l2_enterpriseanalytics.merchlvl90skuandksn`
        WHERE srsdvsn_kmtdept_nbr=195
    ) a2
    ON (COALESCE((CASE WHEN a1.SrsKmtInd = 'S' THEN a1.SKUId else a1.KSNId end), 0) = a2.SrsSKU_KmtKSN_Id 
        AND a1.SrsKmtInd = a2.SrsKmtInd
#select those members who purchased other division/department/category/subcategory in the same quarters
   

SELECT srsdvsn_kmtdept_nbr, srsdvsn_kmtdept_desc, COUNT(1) AS cn
FROM `syw-analytics-repo-prod.l2_enterpriseanalytics.merchlvl90skuandksn`
WHERE srsdvsn_kmtdept_nbr=391
GROUP BY 1,2
ORDER BY cn ASC

           






