# Sears-SQL

with t as(
    select convert_timezone('UTC','America/Los_Angeles',timestamp) as timestamp,loanid
        from "PRODUCTION_DB"."PUBLIC"."BI_LOAN"
        where DISBURSEMENT_AUTH_NZ
        and timestamp>=dateadd(day,-8,current_date())
    ),
    time as (
      select to_date(timestamp) as date
            ,cast(hour(timestamp)+ round(floor(minute(timestamp)/30,0)/2,1) as string) as win
            ,count(distinct loanid) as loans
        from t
        group by 1,2
    ),
    cut_win as(
      select a.date,b.win,dayofweek(a.date) as dow,
            case when loans is null then 0 else loans end as loan_num
      from
        (select date from "STAGING_DB"."PUBLIC"."DATE_DIMENSION" 
            where date>=dateadd(day,-7,current_date()) 
            and date<=current_date()
         ) a  
        cross join "STAGING_DB"."PUBLIC"."HOUR_WIN30" b
        left join time c
        on a.date=c.date and b.win=c.win
    )

    select win,median(loan_num) as md_loan_bywin from cut_win
        where date<current_date()
        group by 1
